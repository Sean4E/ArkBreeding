<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Breeding Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f172a;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #22d3ee;
        }

        .btn {
            background-color: #0891b2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #0e7490;
        }

        .btn-danger {
            background-color: #dc2626;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-success {
            background-color: #16a34a;
        }

        .btn-success:hover {
            background-color: #15803d;
        }

        .btn-outline {
            background: none;
            border: 2px solid #0891b2;
            color: #0891b2;
        }

        .btn-outline:hover {
            background-color: #0891b2;
            color: white;
        }

        .breeding-section {
            background-color: #1e293b;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .breeding-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 20px;
        }

        .breeding-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .perfect-dino-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .perfect-dino-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .parent-selects {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .select-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .select-group select {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .stat-preferences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background-color: #374151;
            border-radius: 8px;
        }

        .stat-preference {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-preference-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .stat-preference select {
            background-color: #4b5563;
            border: 1px solid #6b7280;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 11px;
            width: 80px;
        }

        .potential-offspring {
            background-color: #374151;
            padding: 20px;
            border-radius: 8px;
        }

        .offspring-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .stat-card {
            background-color: #4b5563;
            padding: 12px;
            border-radius: 6px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .stat-details {
            font-size: 11px;
            line-height: 1.4;
        }

        .stat-details div {
            margin-bottom: 2px;
        }

        .mutations {
            color: #fbbf24;
        }

        .dino-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .dino-card {
            background-color: #1e293b;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #374151;
            cursor: grab;
            transition: all 0.2s;
        }

        .dino-card:hover {
            border-color: #22d3ee;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.15);
        }

        .dino-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .dino-card.drag-over-left {
            border-left: 4px solid #22d3ee;
        }

        .dino-card.drag-over-right {
            border-right: 4px solid #22d3ee;
        }

        .dino-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .dino-info {
            flex: 1;
        }

        .dino-info h3 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gender-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .gender-male {
            background-color: #60a5fa;
        }

        .gender-female {
            background-color: #f472b6;
        }

        .dino-info p {
            font-size: 13px;
            color: #cbd5e1;
        }

        .dino-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background-color: #374151;
        }

        .action-btn.edit {
            color: #60a5fa;
        }

        .action-btn.duplicate {
            color: #34d399;
        }

        .action-btn.delete {
            color: #f87171;
        }

        .dino-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .dino-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .dino-stat-value {
            font-weight: 500;
            min-width: 50px;
            font-size: 14px;
            color: white;
        }

        .dino-stat-value.favorite {
            color: #fbbf24;
            font-weight: bold;
        }

        .dino-stat-levels {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .dino-stat-levels.favorite {
            color: #fbbf24;
            font-weight: bold;
        }

        .level-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #374151;
            font-size: 11px;
            color: #94a3b8;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .species-input-group {
            display: flex;
            gap: 8px;
            align-items: end;
        }

        .species-select {
            flex: 1;
        }

        .stats-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .stat-form-row {
            display: grid;
            grid-template-columns: 120px repeat(4, 60px) 80px 30px;
            gap: 12px;
            align-items: end;
            margin-bottom: 15px;
        }

        .stat-form-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .stat-form-group label {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 2px;
        }

        .stat-form-group input {
            padding: 4px 6px;
            font-size: 13px;
            width: 100%;
        }

        .level-display {
            font-size: 11px;
            color: #22d3ee;
            text-align: center;
        }

        .star-favorite {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #4b5563;
            transition: color 0.2s;
            user-select: none;
        }

        .star-favorite:hover {
            color: #fbbf24;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-secondary {
            background: none;
            border: none;
            color: #94a3b8;
            padding: 8px 16px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .btn-secondary:hover {
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state p {
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .species-manager {
            margin-top: 10px;
            padding: 10px;
            background-color: #374151;
            border-radius: 6px;
            font-size: 12px;
        }

        .species-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .species-tag {
            background-color: #4b5563;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .species-remove {
            background: none;
            border: none;
            color: #f87171;
            cursor: pointer;
            font-size: 10px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            filter: brightness(0) invert(1);
        }

        .stat-icon-large {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
            filter: brightness(0) invert(1);
        }

        .stat-icon-small {
            width: 12px;
            height: 12px;
            display: inline-block;
            vertical-align: middle;
            filter: brightness(0) invert(1);
        }

        .import-export-section {
            background-color: #1e293b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .import-export-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .file-input {
            display: none;
        }

        .lineage-section {
            background-color: #1e293b;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .lineage-tree {
            display: flex;
            flex-direction: column;
            gap: 40px;
            overflow-x: auto;
            overflow-y: visible;
            padding: 20px 20px 20px 60px;
            min-height: 200px;
            width: 100%;
        }

        .generation-level {
            display: flex;
            justify-content: center;
            gap: 60px;
            position: relative;
            min-height: 120px;
            min-width: max-content;
            width: max-content;
            margin: 0 auto;
        }

        .breeding-pair {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .parents-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .parent-node {
            background-color: #374151;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            min-width: 160px;
            border: 2px solid #4b5563;
            position: relative;
        }

        .parent-node.male {
            border-color: #60a5fa;
        }

        .parent-node.female {
            border-color: #f472b6;
        }

        .children-container {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .child-node {
            background-color: #1f2937;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            min-width: 140px;
            border: 2px solid #374151;
            position: relative;
        }

        .child-node.male {
            border-color: #60a5fa;
        }

        .child-node.female {
            border-color: #f472b6;
        }

        .lineage-node h4 {
            font-size: 13px;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 4px;
        }

        .lineage-node p {
            font-size: 11px;
            color: #cbd5e1;
            margin: 2px 0;
        }

        .parent-node h4 {
            font-size: 14px;
        }

        .parent-node p {
            font-size: 12px;
        }

        /* Connection lines */
        .parent-connection {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background-color: #22d3ee;
            z-index: 1;
        }

        .vertical-line {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background-color: #22d3ee;
        }

        .horizontal-line {
            position: absolute;
            top: -10px;
            height: 2px;
            background-color: #22d3ee;
        }

        .child-connection {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background-color: #22d3ee;
        }

        .breeding-info {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0f172a;
            color: #22d3ee;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }

        .generation-label {
            position: absolute;
            left: -60px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #374151;
            color: #22d3ee;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            writing-mode: vertical-rl;
        }

        .orphan-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #4b5563;
        }

        .orphan-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .single-parent-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .single-parent-node {
            background-color: #374151;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 180px;
            border: 2px solid #fbbf24;
            position: relative;
        }

        .single-parent-label {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fbbf24;
            color: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

        .lineage-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        .lineage-filter {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Lineage hover effects */
        .lineage-dino-node {
            transition: all 0.3s ease;
        }

        .lineage-dino-node:hover {
            border-color: #ffffff !important;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            background-color: rgba(255, 255, 255, 0.15) !important;
            transform: scale(1.05);
            z-index: 10;
            position: relative;
        }

        .lineage-dino-node.highlight-parent {
            border-color: #22d3ee !important;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.8);
            background-color: rgba(34, 211, 238, 0.15) !important;
        }

        .lineage-dino-node.highlight-child {
            border-color: #fbbf24 !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            background-color: rgba(251, 191, 36, 0.15) !important;
        }

        .lineage-dino-node.dim {
            opacity: 0.3;
            filter: grayscale(50%);
        }

        .health { color: #f87171; }
        .stamina { color: #fbbf24; }
        .oxygen { color: #60a5fa; }
        .food { color: #34d399; }
        .weight { color: #a78bfa; }
        .melee { color: #fb923c; }
        .speed { color: #22d3ee; }

        /* Migration notification */
        .migration-notice {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            border: 2px solid #22d3ee;
            border-radius: 8px;
            padding: 20px;
            z-index: 1002;
            max-width: 500px;
            text-align: center;
        }

        .migration-notice.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .parent-selects {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-form-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .dino-stats {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .breeding-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .stat-preferences {
                grid-template-columns: repeat(2, 1fr);
            }

            .parents-container {
                flex-direction: column;
                gap: 10px;
            }

            .parent-connection {
                width: 2px;
                height: 20px;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
            }

            .children-container {
                flex-direction: column;
                gap: 10px;
            }

            .generation-label {
                position: static;
                writing-mode: initial;
                margin-bottom: 10px;
                text-align: center;
            }

            .lineage-controls {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Migration Notice -->
        <div id="migrationNotice" class="migration-notice hidden">
            <h3 style="color: #22d3ee; margin-bottom: 10px;">üîÑ Data Migration Available</h3>
            <p style="margin-bottom: 15px;">We found existing dinosaur data with old ID format. Click below to migrate to the new clean ID system.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" onclick="performMigration()">‚úÖ Migrate Data</button>
                <button class="btn-secondary" onclick="hideMigrationNotice()">Skip</button>
            </div>
        </div>

        <div class="header">
            <h1 class="title">ARK Breeding Tracker</h1>
            <div class="header-actions">
                <div class="import-export-section">
                    <div class="import-export-actions">
                        <button class="btn btn-outline btn-small" onclick="exportData()">üì§ Export</button>
                        <button class="btn btn-outline btn-small" onclick="document.getElementById('importFile').click()">üì• Import</button>
                        <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                        <button class="btn btn-small" onclick="toggleLineageTree()">üå≥ Lineage</button>
                    </div>
                </div>
                <button class="btn" onclick="openAddForm()">+ Add Dinosaur</button>
            </div>
        </div>

        <div class="breeding-section">
            <h2 class="breeding-title">Filters</h2>
            <div class="breeding-controls">
                <div class="select-group" style="min-width: 200px;">
                    <label>Species</label>
                    <select id="speciesFilterMain" onchange="applyFilters()">
                        <option value="all">All Species</option>
                    </select>
                </div>
                <div class="select-group" style="min-width: 150px;">
                    <label>Gender</label>
                    <select id="genderFilter" onchange="applyFilters()">
                        <option value="all">All Genders</option>
                        <option value="Male">‚ôÇÔ∏è Male</option>
                        <option value="Female">‚ôÄÔ∏è Female</option>
                    </select>
                </div>
                <div class="perfect-dino-toggle">
                    <input type="checkbox" id="favoritesOnlyFilter" onchange="applyFilters()">
                    <label for="favoritesOnlyFilter">Show Only Favorites</label>
                </div>
                <button class="btn btn-outline btn-small" onclick="clearAllFilters()">üîÑ Clear Filters</button>
            </div>
            
            <div class="stat-preferences" style="margin-bottom: 0;">
                <div style="grid-column: 1 / -1; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #22d3ee;">
                    Filter by Favorite Stats:
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label health">
                        <img src="images/health.webp" alt="Health" class="stat-icon-small">
                        <span>Health</span>
                    </div>
                    <input type="checkbox" id="healthFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label stamina">
                        <img src="images/stamina.webp" alt="Stamina" class="stat-icon-small">
                        <span>Stamina</span>
                    </div>
                    <input type="checkbox" id="staminaFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label oxygen">
                        <img src="images/oxygen.webp" alt="Oxygen" class="stat-icon-small">
                        <span>Oxygen</span>
                    </div>
                    <input type="checkbox" id="oxygenFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label food">
                        <img src="images/food.webp" alt="Food" class="stat-icon-small">
                        <span>Food</span>
                    </div>
                    <input type="checkbox" id="foodFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label weight">
                        <img src="images/weight.webp" alt="Weight" class="stat-icon-small">
                        <span>Weight</span>
                    </div>
                    <input type="checkbox" id="weightFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label melee">
                        <img src="images/melee.webp" alt="Melee" class="stat-icon-small">
                        <span>Melee</span>
                    </div>
                    <input type="checkbox" id="meleeFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label speed">
                        <img src="images/speed.webp" alt="Speed" class="stat-icon-small">
                        <span>Speed</span>
                    </div>
                    <input type="checkbox" id="speedFilter" onchange="applyFilters()" style="width: 18px; height: 18px;">
                </div>
            </div>
        </div>

        <div id="lineageSection" class="lineage-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="breeding-title">Family Lineage Tree</h2>
                <button class="btn btn-small" onclick="toggleLineageTree()">‚úï Close</button>
            </div>
            <div class="lineage-controls">
                <select id="speciesFilter" class="lineage-filter" onchange="renderLineageTree()">
                    <option value="all">All Species</option>
                </select>
                <div style="color: #94a3b8; font-size: 12px; margin-left: 12px;">
                    Blue borders = ‚ôÇÔ∏è Male ‚Ä¢ Pink borders = ‚ôÄÔ∏è Female ‚Ä¢ Golden stats = Favorites<br>
                    <span style="color: #22d3ee;">üí° Hover any dino: </span>
                    <span style="color: #22d3ee;">Cyan = Their Parents</span> ‚Ä¢ 
                    <span style="color: #fbbf24;">Gold = Their Children</span> ‚Ä¢ 
                    <span style="color: #ffffff;">White = You're hovering</span>
                </div>
            </div>
            <div id="lineageTree" class="lineage-tree"></div>
        </div>

        <div class="breeding-section">
            <h2 class="breeding-title">Breeding Calculator</h2>
            <div class="breeding-controls">
                <div class="perfect-dino-toggle">
                    <input type="checkbox" id="perfectDinoMode" onchange="togglePerfectDinoMode()">
                    <label for="perfectDinoMode">Perfect Dino Mode</label>
                </div>
            </div>
            
            <div id="statPreferences" class="stat-preferences" style="display: none;">
                <div class="stat-preference">
                    <div class="stat-preference-label health">
                        <img src="images/health.webp" alt="Health" class="stat-icon-small">
                        <span>Health</span>
                    </div>
                    <select id="healthPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label stamina">
                        <img src="images/stamina.webp" alt="Stamina" class="stat-icon-small">
                        <span>Stamina</span>
                    </div>
                    <select id="staminaPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label oxygen">
                        <img src="images/oxygen.webp" alt="Oxygen" class="stat-icon-small">
                        <span>Oxygen</span>
                    </div>
                    <select id="oxygenPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label food">
                        <img src="images/food.webp" alt="Food" class="stat-icon-small">
                        <span>Food</span>
                    </div>
                    <select id="foodPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label weight">
                        <img src="images/weight.webp" alt="Weight" class="stat-icon-small">
                        <span>Weight</span>
                    </div>
                    <select id="weightPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label melee">
                        <img src="images/melee.webp" alt="Melee" class="stat-icon-small">
                        <span>Melee</span>
                    </div>
                    <select id="meleePref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
                <div class="stat-preference">
                    <div class="stat-preference-label speed">
                        <img src="images/speed.webp" alt="Speed" class="stat-icon-small">
                        <span>Speed</span>
                    </div>
                    <select id="speedPref">
                        <option value="highest">Highest</option>
                        <option value="lowest">Lowest</option>
                    </select>
                </div>
            </div>

            <div class="parent-selects">
                <div class="select-group">
                    <label>Parent 1</label>
                    <select id="parent1Select" onchange="updateBreedingPreview()">
                        <option value="">Select Parent 1</option>
                    </select>
                </div>
                <div class="select-group">
                    <label>Parent 2</label>
                    <select id="parent2Select" onchange="updateBreedingPreview()">
                        <option value="">Select Parent 2</option>
                    </select>
                </div>
            </div>
            <div id="breedingPreview" class="potential-offspring" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 class="offspring-title">Potential Offspring</h3>
                    <button class="btn btn-success btn-small" onclick="savePotentialDino()">üíæ Save as Dino</button>
                </div>
                <div id="offspringStats" class="dino-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background-color: #4b5563; padding: 16px; border-radius: 8px; border: 2px solid #22d3ee;"></div>
                <div id="offspringLevelInfo" class="level-info" style="margin-top: 12px; text-align: center; font-size: 12px; color: #22d3ee;"></div>
            </div>
        </div>

        <div id="dinoGrid" class="dino-grid"></div>

        <div id="emptyState" class="empty-state">
            <p>No dinosaurs added yet</p>
            <p style="color: #64748b;">Click "Add Dinosaur" to start tracking your breeding lines</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Add New Dinosaur</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="dinoName" placeholder="Dinosaur name" onfocus="this.select()">
                </div>
                <div class="form-group">
                    <label>Species</label>
                    <div class="species-input-group">
                        <select id="dinoSpecies" class="species-select" onchange="toggleCustomSpecies()">
                            <option value="">Select Species</option>
                        </select>
                        <button type="button" class="btn btn-small" onclick="toggleSpeciesManager()">Manage</button>
                    </div>
                    <input type="text" id="customSpecies" placeholder="Custom species" style="display: none; margin-top: 8px;" onfocus="this.select()">
                    <div id="speciesManager" class="species-manager" style="display: none;">
                        <div>
                            <input type="text" id="newSpecies" placeholder="Add new species" onfocus="this.select()" style="width: 200px; margin-right: 8px;">
                            <button type="button" class="btn btn-small" onclick="addSpecies()">Add</button>
                        </div>
                        <div class="species-list" id="speciesList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="dinoGender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Level</label>
                    <input type="number" id="dinoLevel" value="1" min="1" onfocus="this.select()">
                </div>
                <div class="form-group">
                    <label>Parent 1 (Optional)</label>
                    <select id="dinoParent1">
                        <option value="">No Parent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Parent 2 (Optional)</label>
                    <select id="dinoParent2">
                        <option value="">No Parent</option>
                    </select>
                </div>
            </div>

            <div class="stats-section">
                <h3>Stats</h3>
                <div id="statsForm"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="saveDino()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // CLEAN SLATE ID SYSTEM - ROBUST & BULLETPROOF
        // ===============================================
        
        // Global variables
        let dinosaurs = [];
        let editingId = null;
        let currentPotentialOffspring = null;
        let nextId = 1; // Simple, clean integer IDs starting at 1
        let customSpeciesList = [
            'Rex', 'Raptor', 'Spino', 'Carno', 'Trike', 'Stego', 'Bronto', 'Parasaur', 'Dilo', 'Compy',
            'Argentavis', 'Pteranodon', 'Quetzal', 'Ankylo', 'Doed', 'Beaver', 'Mammoth', 'Theri', 'Giga',
            'Mosasaur', 'Megalodon', 'Plesi', 'Ichthy', 'Sarco', 'Bary', 'Kapro', 'Arthro', 'Scorp', 'Spider',
            'Griffin', 'Phoenix', 'Wyvern', 'Drake', 'Basilisk', 'Reaper', 'Karkinos', 'Ravager', 'Enforcer'
        ];

        // BULLETPROOF ID Generation - Simple Integer Counter
        function generateId() {
            return nextId++;
        }

        // BULLETPROOF ID Management - Keep track of highest ID
        function updateNextId() {
            if (dinosaurs.length === 0) {
                nextId = 1;
                return;
            }
            
            const maxId = Math.max(...dinosaurs.map(d => d.id));
            nextId = maxId + 1;
            console.log(`üìä Updated nextId to: ${nextId}`);
        }

        // ===============================================
        // MIGRATION SYSTEM - FROM OLD TO NEW
        // ===============================================

        // Check if migration is needed
        function needsMigration() {
            if (dinosaurs.length === 0) return false;
            
            // Check for fractional IDs (old system)
            const hasFractionalIds = dinosaurs.some(d => !Number.isInteger(d.id) || d.id > 1000000000000);
            
            console.log(`üîç Migration check: ${hasFractionalIds ? 'NEEDED' : 'NOT NEEDED'}`);
            return hasFractionalIds;
        }

        // Show migration notice
        function showMigrationNotice() {
            if (needsMigration()) {
                document.getElementById('migrationNotice').classList.remove('hidden');
                console.log('üì¢ Showing migration notice');
            }
        }

        // Hide migration notice
        function hideMigrationNotice() {
            document.getElementById('migrationNotice').classList.add('hidden');
        }

        // PERFORM COMPLETE MIGRATION - REBUILD EVERYTHING FROM SCRATCH
        function performMigration() {
            console.log('üöÄ Starting complete data migration...');
            console.log(`üìä Found ${dinosaurs.length} dinosaurs to migrate`);
            
            if (dinosaurs.length === 0) {
                hideMigrationNotice();
                return;
            }
            
            // Step 1: Create ID mapping from old to new
            const idMap = new Map();
            let newId = 1;
            
            // Assign new clean integer IDs
            dinosaurs.forEach(dino => {
                const oldId = dino.id;
                idMap.set(oldId, newId);
                dino.id = newId;
                console.log(`üîÑ ${dino.name}: ${oldId} ‚Üí ${newId}`);
                newId++;
            });
            
            // Step 2: Update all parent references
            dinosaurs.forEach(dino => {
                if (dino.parent1Id) {
                    const newParent1Id = idMap.get(dino.parent1Id);
                    if (newParent1Id) {
                        dino.parent1Id = newParent1Id;
                        console.log(`‚úÖ Fixed ${dino.name} parent1: ‚Üí ${newParent1Id}`);
                    } else {
                        console.log(`‚ö†Ô∏è ${dino.name} parent1 not found, setting to null`);
                        dino.parent1Id = null;
                    }
                }
                
                if (dino.parent2Id) {
                    const newParent2Id = idMap.get(dino.parent2Id);
                    if (newParent2Id) {
                        dino.parent2Id = newParent2Id;
                        console.log(`‚úÖ Fixed ${dino.name} parent2: ‚Üí ${newParent2Id}`);
                    } else {
                        console.log(`‚ö†Ô∏è ${dino.name} parent2 not found, setting to null`);
                        dino.parent2Id = null;
                    }
                }
            });
            
            // Step 3: Update nextId counter
            nextId = newId;
            
            // Step 4: Save and refresh everything
            saveData();
            renderDinosaurs();
            updateParentSelects();
            updateModalParentSelects();
            populateSpeciesFilter();
            populateMainSpeciesFilter();
            
            // Hide notice and show success
            hideMigrationNotice();
            
            console.log(`‚úÖ Migration complete! All ${dinosaurs.length} dinosaurs now have clean integer IDs (1-${newId-1})`);
            alert(`üéâ Migration successful!\n\n‚úÖ Migrated ${dinosaurs.length} dinosaurs\n‚úÖ Fixed all parent relationships\n‚úÖ Clean integer IDs (1-${newId-1})\n\nYour lineage tree should now work perfectly!`);
        }

        // ===============================================
        // CORE FUNCTIONS - REBUILT FOR ROBUSTNESS
        // ===============================================

        // Stat configuration
        const statConfig = {
            health: { name: 'Health', icon: 'images/health.webp', color: 'health' },
            stamina: { name: 'Stamina', icon: 'images/stamina.webp', color: 'stamina' },
            oxygen: { name: 'Oxygen', icon: 'images/oxygen.webp', color: 'oxygen' },
            food: { name: 'Food', icon: 'images/food.webp', color: 'food' },
            weight: { name: 'Weight', icon: 'images/weight.webp', color: 'weight' },
            melee: { name: 'Melee', icon: 'images/melee.webp', color: 'melee' },
            speed: { name: 'Speed', icon: 'images/speed.webp', color: 'speed' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateNextId();
            showMigrationNotice(); // Check if migration is needed
            populateSpeciesDropdown();
            createStatsForm();
            renderDinosaurs();
            updateParentSelects();
            updateModalParentSelects();
            setupStatPreferenceListeners();
            populateSpeciesFilter();
            populateMainSpeciesFilter();
        });

        // ROBUST Data management
        function loadData() {
            const saved = localStorage.getItem('arkBreedingData');
            if (saved) {
                dinosaurs = JSON.parse(saved);
                console.log(`üìÇ Loaded ${dinosaurs.length} dinosaurs from storage`);
            }
            
            const savedSpecies = localStorage.getItem('arkSpeciesList');
            if (savedSpecies) {
                customSpeciesList = JSON.parse(savedSpecies);
            }
        }

        function saveData() {
            localStorage.setItem('arkBreedingData', JSON.stringify(dinosaurs));
            localStorage.setItem('arkSpeciesList', JSON.stringify(customSpeciesList));
            console.log(`üíæ Saved ${dinosaurs.length} dinosaurs to storage`);
        }

        // ROBUST Parent lookups - simple integer comparison
        function findDinoById(id) {
            return dinosaurs.find(d => d.id === id);
        }

        function getChildren(parentId) {
            return dinosaurs.filter(d => d.parent1Id === parentId || d.parent2Id === parentId);
        }

        function getParents(dino) {
            const parents = [];
            if (dino.parent1Id) {
                const parent1 = findDinoById(dino.parent1Id);
                if (parent1) parents.push(parent1);
            }
            if (dino.parent2Id) {
                const parent2 = findDinoById(dino.parent2Id);
                if (parent2) parents.push(parent2);
            }
            return parents;
        }

        // Filtering functions
        function populateMainSpeciesFilter() {
            const speciesFilter = document.getElementById('speciesFilterMain');
            const species = [...new Set(dinosaurs.map(d => d.species))].sort();
            
            const currentValue = speciesFilter.value;
            speciesFilter.innerHTML = '<option value="all">All Species</option>';
            species.forEach(sp => {
                const option = document.createElement('option');
                option.value = sp;
                option.textContent = sp;
                speciesFilter.appendChild(option);
            });
            speciesFilter.value = currentValue;
        }

        function applyFilters() {
            renderDinosaurs();
        }

        function clearAllFilters() {
            document.getElementById('speciesFilterMain').value = 'all';
            document.getElementById('genderFilter').value = 'all';
            document.getElementById('favoritesOnlyFilter').checked = false;
            
            // Clear all stat filters
            Object.keys(statConfig).forEach(stat => {
                document.getElementById(`${stat}Filter`).checked = false;
            });
            
            applyFilters();
        }

        function getFilteredDinosaurs() {
            let filtered = [...dinosaurs];
            
            // Species filter
            const speciesFilter = document.getElementById('speciesFilterMain').value;
            if (speciesFilter !== 'all') {
                filtered = filtered.filter(dino => dino.species === speciesFilter);
            }
            
            // Gender filter
            const genderFilter = document.getElementById('genderFilter').value;
            if (genderFilter !== 'all') {
                filtered = filtered.filter(dino => dino.gender === genderFilter);
            }
            
            // Favorites only filter
            const favoritesOnly = document.getElementById('favoritesOnlyFilter').checked;
            if (favoritesOnly) {
                filtered = filtered.filter(dino => {
                    return Object.values(dino.stats).some(stat => stat.favorite);
                });
            }
            
            // Stat filters - show dinos that have ANY of the selected stats as favorites
            const selectedStatFilters = [];
            Object.keys(statConfig).forEach(stat => {
                if (document.getElementById(`${stat}Filter`).checked) {
                    selectedStatFilters.push(stat);
                }
            });
            
            if (selectedStatFilters.length > 0) {
                filtered = filtered.filter(dino => {
                    return selectedStatFilters.some(stat => dino.stats[stat].favorite);
                });
            }
            
            return filtered;
        }

        // Species management
        function populateSpeciesDropdown() {
            const select = document.getElementById('dinoSpecies');
            select.innerHTML = '<option value="">Select Species</option>';
            customSpeciesList.sort().forEach(species => {
                const option = document.createElement('option');
                option.value = species;
                option.textContent = species;
                select.appendChild(option);
            });
            
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Custom...';
            select.appendChild(customOption);
        }

        function toggleCustomSpecies() {
            const select = document.getElementById('dinoSpecies');
            const customInput = document.getElementById('customSpecies');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        function toggleSpeciesManager() {
            const manager = document.getElementById('speciesManager');
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                updateSpeciesList();
            } else {
                manager.style.display = 'none';
            }
        }

        function addSpecies() {
            const input = document.getElementById('newSpecies');
            const species = input.value.trim();
            
            if (species && !customSpeciesList.includes(species)) {
                customSpeciesList.push(species);
                populateSpeciesDropdown();
                populateMainSpeciesFilter();
                updateSpeciesList();
                saveData();
                input.value = '';
                updateBreedingPreview();
            }
        }

        function removeSpecies(species) {
            customSpeciesList = customSpeciesList.filter(s => s !== species);
            populateSpeciesDropdown();
            populateMainSpeciesFilter();
            updateSpeciesList();
            saveData();
            updateBreedingPreview();
        }

        function updateSpeciesList() {
            const list = document.getElementById('speciesList');
            list.innerHTML = customSpeciesList.map(species => `
                <div class="species-tag">
                    <span>${species}</span>
                    <button class="species-remove" onclick="removeSpecies('${species}')">&times;</button>
                </div>
            `).join('');
        }

        // Perfect Dino Mode
        function togglePerfectDinoMode() {
            const checkbox = document.getElementById('perfectDinoMode');
            const preferences = document.getElementById('statPreferences');
            
            console.log(`üéØ Perfect Dino Mode toggled: ${checkbox.checked}`);
            
            if (checkbox.checked) {
                preferences.style.display = 'grid';
                console.log('üìä Showing stat preferences');
            } else {
                preferences.style.display = 'none';
                console.log('üé≤ Hiding stat preferences - Random mode');
            }
            
            // Immediately update breeding preview to reflect the change
            updateBreedingPreview();
        }

        function setupStatPreferenceListeners() {
            Object.keys(statConfig).forEach(stat => {
                const select = document.getElementById(`${stat}Pref`);
                if (select) {
                    select.addEventListener('change', updateBreedingPreview);
                }
            });
        }

        // Calculate total levels
        function calculateTotalLevels(stats) {
            let total = 0;
            Object.values(stats).forEach(stat => {
                total += stat.wild + stat.tamed;
            });
            return total;
        }

        // Update level calculation display
        function updateLevelCalculation() {
            Object.keys(statConfig).forEach(stat => {
                const wild = parseInt(document.getElementById(`${stat}Wild`).value) || 0;
                const tamed = parseInt(document.getElementById(`${stat}Tamed`).value) || 0;
                const display = document.getElementById(`${stat}LevelDisplay`);
                if (display) {
                    display.textContent = `${wild + tamed}`;
                }
            });
            
            // Calculate total
            let totalLevels = 0;
            Object.keys(statConfig).forEach(stat => {
                const wild = parseInt(document.getElementById(`${stat}Wild`).value) || 0;
                const tamed = parseInt(document.getElementById(`${stat}Tamed`).value) || 0;
                totalLevels += wild + tamed;
            });
            
            const baseLevel = parseInt(document.getElementById('dinoLevel').value) || 1;
            const finalLevel = baseLevel + totalLevels;
            
            document.getElementById('totalLevelDisplay').textContent = `Base: ${baseLevel} + Stats: ${totalLevels} = Total: ${finalLevel}`;
        }

        // Simple star toggle function
        function toggleStar(stat) {
            const star = document.getElementById(`star_${stat}`);
            if (star.textContent === '‚òÜ') {
                star.textContent = '‚òÖ';
                star.style.color = '#fbbf24';
            } else {
                star.textContent = '‚òÜ';
                star.style.color = '#4b5563';
            }
        }

        // Create stats form
        function createStatsForm() {
            const statsForm = document.getElementById('statsForm');
            
            // Add total level display
            const totalDisplay = document.createElement('div');
            totalDisplay.innerHTML = `
                <div id="totalLevelDisplay" style="background-color: #374151; padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold; color: #22d3ee;">
                    Base: 1 + Stats: 0 = Total: 1
                </div>
            `;
            statsForm.appendChild(totalDisplay);
            
            Object.entries(statConfig).forEach(([key, config]) => {
                const row = document.createElement('div');
                row.className = 'stat-form-row';
                row.innerHTML = `
                    <div class="stat-form-label ${config.color}">
                        <img src="${config.icon}" alt="${config.name}" class="stat-icon">
                        <span>${config.name}</span>
                    </div>
                    <div class="stat-form-group">
                        <label>Value</label>
                        <input type="number" id="${key}Value" value="${key === 'melee' || key === 'speed' ? 100 : 0}" onfocus="this.select()">
                    </div>
                    <div class="stat-form-group">
                        <label>Wild</label>
                        <input type="number" id="${key}Wild" value="0" min="0" onfocus="this.select()" oninput="updateLevelCalculation()">
                    </div>
                    <div class="stat-form-group">
                        <label>Mutations</label>
                        <input type="number" id="${key}Mutations" value="0" min="0" onfocus="this.select()">
                    </div>
                    <div class="stat-form-group">
                        <label>Tamed</label>
                        <input type="number" id="${key}Tamed" value="0" min="0" onfocus="this.select()" oninput="updateLevelCalculation()">
                    </div>
                    <div class="level-display">
                        <div>Total</div>
                        <div id="${key}LevelDisplay">0</div>
                    </div>
                    <div class="star-favorite" onclick="toggleStar('${key}')">
                        <span id="star_${key}">‚òÜ</span>
                    </div>
                `;
                statsForm.appendChild(row);
            });
        }

        // Modal functions
        function openAddForm() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Dinosaur';
            clearForm();
            document.getElementById('modal').classList.remove('hidden');
        }

        function openEditForm(id) {
            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Dinosaur';
            const dino = findDinoById(id);
            if (dino) {
                populateForm(dino);
                document.getElementById('modal').classList.remove('hidden');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('speciesManager').style.display = 'none';
            document.getElementById('customSpecies').style.display = 'none';
        }

        function clearForm() {
            document.getElementById('dinoName').value = '';
            document.getElementById('dinoSpecies').value = '';
            document.getElementById('customSpecies').value = '';
            document.getElementById('customSpecies').style.display = 'none';
            document.getElementById('dinoGender').value = 'Male';
            document.getElementById('dinoLevel').value = '1';
            document.getElementById('dinoParent1').value = '';
            document.getElementById('dinoParent2').value = '';
            
            Object.keys(statConfig).forEach(stat => {
                document.getElementById(`${stat}Value`).value = stat === 'melee' || stat === 'speed' ? 100 : 0;
                document.getElementById(`${stat}Wild`).value = 0;
                document.getElementById(`${stat}Mutations`).value = 0;
                document.getElementById(`${stat}Tamed`).value = 0;
                
                // Reset stars
                const star = document.getElementById(`star_${stat}`);
                star.textContent = '‚òÜ';
                star.style.color = '#4b5563';
            });
            
            updateLevelCalculation();
        }

        function populateForm(dino) {
            document.getElementById('dinoName').value = dino.name;
            
            if (customSpeciesList.includes(dino.species)) {
                document.getElementById('dinoSpecies').value = dino.species;
            } else {
                document.getElementById('dinoSpecies').value = 'custom';
                document.getElementById('customSpecies').value = dino.species;
                document.getElementById('customSpecies').style.display = 'block';
            }
            
            document.getElementById('dinoGender').value = dino.gender;
            document.getElementById('dinoLevel').value = dino.level;
            document.getElementById('dinoParent1').value = dino.parent1Id || '';
            document.getElementById('dinoParent2').value = dino.parent2Id || '';
            
            Object.keys(statConfig).forEach(stat => {
                const statData = dino.stats[stat];
                document.getElementById(`${stat}Value`).value = statData.value;
                document.getElementById(`${stat}Wild`).value = statData.wild;
                document.getElementById(`${stat}Mutations`).value = statData.mutations;
                document.getElementById(`${stat}Tamed`).value = statData.tamed;
                
                // Set star state
                const star = document.getElementById(`star_${stat}`);
                if (statData.favorite) {
                    star.textContent = '‚òÖ';
                    star.style.color = '#fbbf24';
                } else {
                    star.textContent = '‚òÜ';
                    star.style.color = '#4b5563';
                }
            });
            
            updateLevelCalculation();
        }

        // ROBUST Duplicate dinosaur with clean ID
        function duplicateDino(id) {
            const originalDino = findDinoById(id);
            if (!originalDino) return;
            
            // Create unique name
            let baseName = originalDino.name;
            let copyNumber = 1;
            let newName = `${baseName} (Copy)`;
            
            while (dinosaurs.some(d => d.name === newName)) {
                copyNumber++;
                newName = `${baseName} (Copy ${copyNumber})`;
            }
            
            const duplicatedDino = {
                ...originalDino,
                id: generateId(), // Clean integer ID
                name: newName,
                dateAdded: new Date().toISOString()
            };
            
            dinosaurs.push(duplicatedDino);
            console.log(`üìÑ Duplicated ${originalDino.name} ‚Üí ${newName} (ID: ${duplicatedDino.id})`);
            
            saveData();
            renderDinosaurs();
            updateParentSelects();
            updateModalParentSelects();
            populateSpeciesFilter();
            populateMainSpeciesFilter();
            updateBreedingPreview();
        }

        // ROBUST Save dinosaur with clean ID
        function saveDino() {
            const name = document.getElementById('dinoName').value.trim();
            let species = document.getElementById('dinoSpecies').value;
            
            if (species === 'custom') {
                species = document.getElementById('customSpecies').value.trim();
            }
            
            if (!name || !species) {
                alert('Please fill in name and species');
                return;
            }

            const stats = {};
            Object.keys(statConfig).forEach(stat => {
                const star = document.getElementById(`star_${stat}`);
                stats[stat] = {
                    value: parseInt(document.getElementById(`${stat}Value`).value) || 0,
                    wild: parseInt(document.getElementById(`${stat}Wild`).value) || 0,
                    mutations: parseInt(document.getElementById(`${stat}Mutations`).value) || 0,
                    tamed: parseInt(document.getElementById(`${stat}Tamed`).value) || 0,
                    favorite: star && star.textContent === '‚òÖ'
                };
            });

            // ROBUST parent ID handling - clean integers only
            const parent1Value = document.getElementById('dinoParent1').value;
            const parent2Value = document.getElementById('dinoParent2').value;
            
            const dinoData = {
                id: editingId || generateId(), // Clean integer ID
                name: name,
                species: species,
                gender: document.getElementById('dinoGender').value,
                level: parseInt(document.getElementById('dinoLevel').value) || 1,
                stats: stats,
                parent1Id: parent1Value ? parseInt(parent1Value) : null,
                parent2Id: parent2Value ? parseInt(parent2Value) : null,
                dateAdded: editingId ? findDinoById(editingId)?.dateAdded : new Date().toISOString()
            };

            console.log(`üíæ Saving dino: ${dinoData.name} (ID: ${dinoData.id})`);

            if (editingId) {
                const index = dinosaurs.findIndex(d => d.id === editingId);
                dinosaurs[index] = dinoData;
            } else {
                dinosaurs.push(dinoData);
            }

            saveData();
            renderDinosaurs();
            updateParentSelects();
            updateModalParentSelects();
            populateSpeciesFilter();
            populateMainSpeciesFilter();
            updateBreedingPreview();
            closeModal();
        }

        // Delete dinosaur
        function deleteDino(id) {
            const dino = findDinoById(id);
            if (!dino) return;
            
            if (confirm(`Are you sure you want to delete ${dino.name}?`)) {
                dinosaurs = dinosaurs.filter(d => d.id !== id);
                console.log(`üóëÔ∏è Deleted ${dino.name} (ID: ${id})`);
                
                saveData();
                renderDinosaurs();
                updateParentSelects();
                updateModalParentSelects();
                populateSpeciesFilter();
                populateMainSpeciesFilter();
                updateBreedingPreview();
                currentPotentialOffspring = null;
            }
        }

        // Format stat value
        function formatStatValue(value, stat) {
            if (stat === 'melee' || stat === 'speed') {
                return `${value}%`;
            }
            if (value >= 1000) {
                return `${(value / 1000).toFixed(1)}K`;
            }
            return value.toString();
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const dinoCards = document.querySelectorAll('.dino-card');
            
            dinoCards.forEach(card => {
                card.draggable = true;
                
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.dinoId);
                });
                
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
                
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    
                    const rect = card.getBoundingClientRect();
                    const midpoint = rect.left + rect.width / 2;
                    const isLeftSide = e.clientX < midpoint;
                    
                    card.classList.remove('drag-over-left', 'drag-over-right');
                    
                    if (isLeftSide) {
                        card.classList.add('drag-over-left');
                    } else {
                        card.classList.add('drag-over-right');
                    }
                });
                
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over-left', 'drag-over-right');
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over-left', 'drag-over-right');
                    
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = parseInt(card.dataset.dinoId);
                    
                    if (draggedId !== targetId) {
                        const rect = card.getBoundingClientRect();
                        const midpoint = rect.left + rect.width / 2;
                        const isLeftSide = e.clientX < midpoint;
                        
                        const draggedIndex = dinosaurs.findIndex(d => d.id === draggedId);
                        const targetIndex = dinosaurs.findIndex(d => d.id === targetId);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            const draggedDino = dinosaurs.splice(draggedIndex, 1)[0];
                            
                            let insertIndex = targetIndex;
                            if (draggedIndex < targetIndex) {
                                insertIndex--;
                            }
                            
                            if (!isLeftSide) {
                                insertIndex++;
                            }
                            
                            dinosaurs.splice(insertIndex, 0, draggedDino);
                            
                            saveData();
                            renderDinosaurs();
                        }
                    }
                });
            });
        }

        // Render dinosaurs
        function renderDinosaurs() {
            const dinoGrid = document.getElementById('dinoGrid');
            const emptyState = document.getElementById('emptyState');
            
            const filteredDinosaurs = getFilteredDinosaurs();
            
            if (filteredDinosaurs.length === 0) {
                dinoGrid.style.display = 'none';
                if (dinosaurs.length === 0) {
                    emptyState.innerHTML = `
                        <p>No dinosaurs added yet</p>
                        <p style="color: #64748b;">Click "Add Dinosaur" to start tracking your breeding lines</p>
                    `;
                } else {
                    emptyState.innerHTML = `
                        <p>No dinosaurs match the current filters</p>
                        <p style="color: #64748b;">Try adjusting your filter settings</p>
                    `;
                }
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            dinoGrid.style.display = 'grid';
            
            dinoGrid.innerHTML = filteredDinosaurs.map(dino => {
                const totalLevels = calculateTotalLevels(dino.stats);
                const finalLevel = dino.level + totalLevels;
                
                return `
                    <div class="dino-card" data-dino-id="${dino.id}">
                        <div class="dino-header">
                            <div class="dino-info">
                                <h3>
                                    <span class="gender-indicator ${dino.gender === 'Male' ? 'gender-male' : 'gender-female'}"></span>
                                    ${dino.name}
                                </h3>
                                <p>${dino.species} ‚Ä¢ ${dino.gender} ‚Ä¢ Level ${finalLevel} ‚Ä¢ ID: ${dino.id}</p>
                            </div>
                            <div class="dino-actions">
                                <button class="action-btn edit" onclick="openEditForm(${dino.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="action-btn duplicate" onclick="duplicateDino(${dino.id})" title="Duplicate">üìÑ</button>
                                <button class="action-btn delete" onclick="deleteDino(${dino.id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="dino-stats">
                            ${Object.entries(dino.stats).map(([stat, data]) => {
                                const isFavorite = data.favorite || false;
                                return `
                                <div class="dino-stat">
                                    <img src="${statConfig[stat].icon}" alt="${statConfig[stat].name}" class="stat-icon ${statConfig[stat].color}">
                                    <span class="dino-stat-value ${isFavorite ? 'favorite' : ''}">${formatStatValue(data.value, stat)}</span>
                                    <span class="dino-stat-levels ${isFavorite ? 'favorite' : ''}">(${data.wild}-${data.mutations}-${data.tamed})</span>
                                </div>
                            `}).join('')}
                        </div>
                        <div class="level-info">
                            Base: ${dino.level} + Stats: ${totalLevels} = Total: ${finalLevel}
                        </div>
                    </div>
                `;
            }).join('');
            
            setupDragAndDrop();
        }

        // ROBUST Update parent selects with clean IDs
        function updateParentSelects() {
            const parent1Select = document.getElementById('parent1Select');
            const parent2Select = document.getElementById('parent2Select');
            
            const currentParent1 = parent1Select.value;
            const currentParent2 = parent2Select.value;
            
            parent1Select.innerHTML = '<option value="">Select Parent 1</option>';
            parent2Select.innerHTML = '<option value="">Select Parent 2</option>';
            
            dinosaurs.forEach(dino => {
                const genderIcon = dino.gender === 'Male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                const optionText = `${genderIcon} ${dino.name} (${dino.species}) [ID: ${dino.id}]`;
                
                const option1 = document.createElement('option');
                option1.value = dino.id;
                option1.textContent = optionText;
                parent1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = dino.id;
                option2.textContent = optionText;
                parent2Select.appendChild(option2);
            });
            
            parent1Select.value = currentParent1;
            parent2Select.value = currentParent2;
        }

        // ROBUST Update modal parent selects with clean IDs
        function updateModalParentSelects() {
            const parent1Select = document.getElementById('dinoParent1');
            const parent2Select = document.getElementById('dinoParent2');
            
            const currentParent1 = parent1Select.value;
            const currentParent2 = parent2Select.value;
            
            parent1Select.innerHTML = '<option value="">No Parent</option>';
            parent2Select.innerHTML = '<option value="">No Parent</option>';
            
            dinosaurs.forEach(dino => {
                const genderIcon = dino.gender === 'Male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                const optionText = `${genderIcon} ${dino.name} (${dino.species}) [ID: ${dino.id}]`;
                
                const option1 = document.createElement('option');
                option1.value = dino.id;
                option1.textContent = optionText;
                parent1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = dino.id;
                option2.textContent = optionText;
                parent2Select.appendChild(option2);
            });
            
            parent1Select.value = currentParent1;
            parent2Select.value = currentParent2;
        }

        // Update breeding preview
        function updateBreedingPreview() {
            const parent1Id = parseInt(document.getElementById('parent1Select').value);
            const parent2Id = parseInt(document.getElementById('parent2Select').value);
            const preview = document.getElementById('breedingPreview');
            const offspringStats = document.getElementById('offspringStats');
            const offspringLevelInfo = document.getElementById('offspringLevelInfo');
            const perfectMode = document.getElementById('perfectDinoMode').checked;
            
            console.log(`üß¨ Breeding Preview: Parent1=${parent1Id}, Parent2=${parent2Id}, Perfect Mode=${perfectMode}`);
            
            if (!parent1Id || !parent2Id || parent1Id === parent2Id) {
                preview.style.display = 'none';
                currentPotentialOffspring = null;
                return;
            }
            
            const parent1 = findDinoById(parent1Id);
            const parent2 = findDinoById(parent2Id);
            
            if (!parent1 || !parent2) {
                preview.style.display = 'none';
                currentPotentialOffspring = null;
                return;
            }
            
            console.log(`üß¨ Parents: ${parent1.name} x ${parent2.name}`);
            
            // Calculate potential offspring stats
            const potentialStats = {};
            let totalWildLevels = 0;
            let totalTamedLevels = 0;
            let totalMutations = 0;
            
            Object.keys(statConfig).forEach(stat => {
                const p1Stat = parent1.stats[stat];
                const p2Stat = parent2.stats[stat];
                
                let chosenValue, chosenWild, chosenTamed, chosenMutations, chosenParent;
                
                if (perfectMode) {
                    // Perfect mode - use preferences to choose best stats
                    const preferenceElement = document.getElementById(`${stat}Pref`);
                    const preference = preferenceElement ? preferenceElement.value : 'highest';
                    
                    console.log(`üéØ ${stat}: P1=${p1Stat.value}, P2=${p2Stat.value}, Preference=${preference}`);
                    
                    if (preference === 'highest') {
                        if (p1Stat.value > p2Stat.value) {
                            chosenValue = p1Stat.value;
                            chosenWild = p1Stat.wild;
                            chosenTamed = p1Stat.tamed;
                            chosenMutations = p1Stat.mutations;
                            chosenParent = parent1.name;
                        } else if (p2Stat.value > p1Stat.value) {
                            chosenValue = p2Stat.value;
                            chosenWild = p2Stat.wild;
                            chosenTamed = p2Stat.tamed;
                            chosenMutations = p2Stat.mutations;
                            chosenParent = parent2.name;
                        } else {
                            // Equal values - choose parent 1 by default
                            chosenValue = p1Stat.value;
                            chosenWild = p1Stat.wild;
                            chosenTamed = p1Stat.tamed;
                            chosenMutations = p1Stat.mutations;
                            chosenParent = parent1.name;
                        }
                    } else { // preference === 'lowest'
                        if (p1Stat.value < p2Stat.value) {
                            chosenValue = p1Stat.value;
                            chosenWild = p1Stat.wild;
                            chosenTamed = p1Stat.tamed;
                            chosenMutations = p1Stat.mutations;
                            chosenParent = parent1.name;
                        } else if (p2Stat.value < p1Stat.value) {
                            chosenValue = p2Stat.value;
                            chosenWild = p2Stat.wild;
                            chosenTamed = p2Stat.tamed;
                            chosenMutations = p2Stat.mutations;
                            chosenParent = parent2.name;
                        } else {
                            // Equal values - choose parent 1 by default
                            chosenValue = p1Stat.value;
                            chosenWild = p1Stat.wild;
                            chosenTamed = p1Stat.tamed;
                            chosenMutations = p1Stat.mutations;
                            chosenParent = parent1.name;
                        }
                    }
                    
                    console.log(`‚úÖ ${stat}: Chose ${chosenValue} from ${chosenParent} (${preference})`);
                } else {
                    // Random mode - show both possibilities or random choice
                    const randomChoice = Math.random() < 0.5;
                    const chosenStat = randomChoice ? p1Stat : p2Stat;
                    chosenValue = chosenStat.value;
                    chosenWild = chosenStat.wild;
                    chosenTamed = chosenStat.tamed;
                    chosenMutations = chosenStat.mutations;
                    chosenParent = randomChoice ? parent1.name : parent2.name;
                    
                    console.log(`üé≤ ${stat}: Random chose ${chosenValue} from ${chosenParent}`);
                }
                
                potentialStats[stat] = {
                    value: chosenValue,
                    wild: chosenWild,
                    tamed: chosenTamed,
                    mutations: chosenMutations,
                    favorite: p1Stat.favorite || p2Stat.favorite || false
                };
                
                totalWildLevels += chosenWild;
                totalTamedLevels += chosenTamed;
                totalMutations += chosenMutations;
            });
            
            currentPotentialOffspring = {
                stats: potentialStats,
                baseLevel: Math.max(parent1.level, parent2.level),
                species: parent1.species === parent2.species ? parent1.species : `${parent1.species}/${parent2.species}`,
                perfectMode: perfectMode
            };
            
            let statsHtml = '';
            Object.keys(statConfig).forEach(stat => {
                const statData = potentialStats[stat];
                const config = statConfig[stat];
                const isFavorite = statData.favorite;
                
                statsHtml += `
                    <div class="dino-stat">
                        <img src="${config.icon}" alt="${config.name}" class="stat-icon ${config.color}">
                        <span class="dino-stat-value ${isFavorite ? 'favorite' : ''}">${formatStatValue(statData.value, stat)}</span>
                        <span class="dino-stat-levels ${isFavorite ? 'favorite' : ''}">(${statData.wild}-${statData.mutations}-${statData.tamed})</span>
                    </div>
                `;
            });
            
            offspringStats.innerHTML = statsHtml;
            
            const totalStatLevels = totalWildLevels + totalTamedLevels;
            const finalLevel = currentPotentialOffspring.baseLevel + totalStatLevels;
            const modeText = perfectMode ? 
                '<br><span style="color: #22d3ee;">üéØ Perfect Dino Mode - Using Preferences</span>' : 
                '<br><span style="color: #fbbf24;">üé≤ Random Inheritance Preview</span>';
            
            offspringLevelInfo.innerHTML = `
                Base: ${currentPotentialOffspring.baseLevel} + Stats: ${totalStatLevels} = Total: ${finalLevel}
                ${modeText}
            `;
            
            preview.style.display = 'block';
        }

        // Save potential dino
        function savePotentialDino() {
            if (!currentPotentialOffspring) {
                alert('No potential offspring to save');
                return;
            }
            
            const parent1Id = document.getElementById('parent1Select').value;
            const parent2Id = document.getElementById('parent2Select').value;
            
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Save Potential Offspring';
            
            document.getElementById('dinoName').value = `${currentPotentialOffspring.perfectMode ? 'Perfect ' : 'Potential '}${currentPotentialOffspring.species}`;
            
            if (customSpeciesList.includes(currentPotentialOffspring.species)) {
                document.getElementById('dinoSpecies').value = currentPotentialOffspring.species;
                document.getElementById('customSpecies').style.display = 'none';
            } else {
                document.getElementById('dinoSpecies').value = 'custom';
                document.getElementById('customSpecies').value = currentPotentialOffspring.species;
                document.getElementById('customSpecies').style.display = 'block';
            }
            
            document.getElementById('dinoGender').value = 'Male';
            document.getElementById('dinoLevel').value = currentPotentialOffspring.baseLevel;
            document.getElementById('dinoParent1').value = parent1Id || '';
            document.getElementById('dinoParent2').value = parent2Id || '';
            
            Object.keys(statConfig).forEach(stat => {
                const statData = currentPotentialOffspring.stats[stat];
                document.getElementById(`${stat}Value`).value = statData.value;
                document.getElementById(`${stat}Wild`).value = statData.wild;
                document.getElementById(`${stat}Mutations`).value = statData.mutations;
                document.getElementById(`${stat}Tamed`).value = statData.tamed;
                
                const star = document.getElementById(`star_${stat}`);
                if (statData.favorite) {
                    star.textContent = '‚òÖ';
                    star.style.color = '#fbbf24';
                } else {
                    star.textContent = '‚òÜ';
                    star.style.color = '#4b5563';
                }
            });
            
            updateLevelCalculation();
            document.getElementById('modal').classList.remove('hidden');
        }

        // Populate species filter
        function populateSpeciesFilter() {
            const speciesFilter = document.getElementById('speciesFilter');
            const species = [...new Set(dinosaurs.map(d => d.species))].sort();
            
            speciesFilter.innerHTML = '<option value="all">All Species</option>';
            species.forEach(sp => {
                const option = document.createElement('option');
                option.value = sp;
                option.textContent = sp;
                speciesFilter.appendChild(option);
            });
        }

        // Toggle lineage tree visibility
        function toggleLineageTree() {
            const section = document.getElementById('lineageSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                renderLineageTree();
            } else {
                section.style.display = 'none';
            }
        }

        // ROBUST Build generational family tree
        function buildGenerationalFamilyTree() {
            const generationMap = new Map();
            const orphans = [];
            
            console.log('üå≥ Building family tree with clean IDs...');
            
            function calculateGeneration(dino, visited = new Set()) {
                if (visited.has(dino.id)) {
                    console.log(`‚ö†Ô∏è Circular reference detected for ${dino.name}`);
                    return 0;
                }
                visited.add(dino.id);
                
                // Foundation animals (no parents)
                if (!dino.parent1Id && !dino.parent2Id) {
                    return 0;
                }
                
                // Find parents using ROBUST lookup
                const parent1 = dino.parent1Id ? findDinoById(dino.parent1Id) : null;
                const parent2 = dino.parent2Id ? findDinoById(dino.parent2Id) : null;
                
                // If any parent is missing, this is an orphan
                if ((dino.parent1Id && !parent1) || (dino.parent2Id && !parent2)) {
                    console.log(`üö´ ${dino.name} is orphaned - missing parent data`);
                    return -1;
                }
                
                // Calculate parent generations
                let maxParentGen = 0;
                if (parent1) {
                    maxParentGen = Math.max(maxParentGen, calculateGeneration(parent1, new Set(visited)));
                }
                if (parent2) {
                    maxParentGen = Math.max(maxParentGen, calculateGeneration(parent2, new Set(visited)));
                }
                
                return maxParentGen + 1;
            }
            
            dinosaurs.forEach(dino => {
                const generation = calculateGeneration(dino);
                
                if (generation === -1) {
                    orphans.push(dino);
                } else {
                    if (!generationMap.has(generation)) {
                        generationMap.set(generation, []);
                    }
                    generationMap.get(generation).push(dino);
                }
            });
            
            console.log(`üìã Family tree built: ${generationMap.size} generations, ${orphans.length} orphans`);
            
            return {
                generations: generationMap,
                orphans: orphans
            };
        }

        // Render generational lineage tree
        function renderLineageTree() {
            const treeContainer = document.getElementById('lineageTree');
            const speciesFilter = document.getElementById('speciesFilter').value;
            
            if (dinosaurs.length === 0) {
                treeContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">No dinosaurs to display lineage for</p>';
                return;
            }
            
            const familyData = buildGenerationalFamilyTree();
            let treeHtml = '';
            
            const sortedGenerations = Array.from(familyData.generations.keys()).sort((a, b) => a - b);
            
            sortedGenerations.forEach(generation => {
                const dinosInGeneration = familyData.generations.get(generation);
                
                const filteredDinos = dinosInGeneration.filter(dino => 
                    speciesFilter === 'all' || dino.species === speciesFilter
                );
                
                if (filteredDinos.length > 0) {
                    const generationLabel = generation === 0 ? 'Foundation' : `Generation ${generation}`;
                    
                    treeHtml += `
                        <div class="generation-level">
                            <div class="generation-label">${generationLabel}</div>
                            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                                ${filteredDinos.map(dino => renderGenerationNode(dino, generation)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            const filteredOrphans = familyData.orphans.filter(dino =>
                speciesFilter === 'all' || dino.species === speciesFilter
            );
            
            if (filteredOrphans.length > 0) {
                treeHtml += `
                    <div class="orphan-section">
                        <h3 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">‚ö†Ô∏è Orphaned Dinos (Missing Parents)</h3>
                        <div class="orphan-container">
                            ${filteredOrphans.map(dino => renderOrphanNode(dino)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (treeHtml === '') {
                treeContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">No lineage data matches the current filters</p>';
            } else {
                treeContainer.innerHTML = treeHtml;
            }
        }

        function renderGenerationNode(dino, generation) {
            const genderIcon = dino.gender === 'Male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
            const totalLevels = calculateTotalLevels(dino.stats);
            const finalLevel = dino.level + totalLevels;
            const genderClass = dino.gender === 'Male' ? 'male' : 'female';
            
            // Get favorite stats
            let favoriteStats = [];
            Object.entries(dino.stats).forEach(([stat, data]) => {
                if (data.favorite) {
                    favoriteStats.push(`${statConfig[stat].name}: ${formatStatValue(data.value, stat)}`);
                }
            });
            
            // Check if this dino has children
            const hasChildren = getChildren(dino.id).length > 0;
            
            // Show parents info for non-foundation animals
            let parentInfo = '';
            if (generation > 0) {
                const parents = getParents(dino);
                const parentNames = parents.map(p => p.name).join(' √ó ');
                if (parentNames) {
                    parentInfo = `<p style="color: #94a3b8; font-size: 9px; margin-top: 2px;">Parents: ${parentNames}</p>`;
                }
            }
            
            return `
                <div class="lineage-dino-node ${genderClass}" 
                     data-dino-id="${dino.id}"
                     data-dino-name="${dino.name}"
                     data-parent1-id="${dino.parent1Id || ''}"
                     data-parent2-id="${dino.parent2Id || ''}"
                     onmouseenter="highlightRelations(${dino.id})"
                     onmouseleave="clearHighlights()"
                     style="
                    background-color: ${generation === 0 ? '#374151' : '#1f2937'};
                    padding: 12px;
                    border-radius: 8px;
                    text-align: center;
                    min-width: 160px;
                    border: 2px solid ${generation === 0 ? '#fbbf24' : (dino.gender === 'Male' ? '#60a5fa' : '#f472b6')};
                    position: relative;
                    margin: 5px;
                    cursor: pointer;
                ">
                    ${generation === 0 ? '<div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background-color: #fbbf24; color: #0f172a; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold;">FOUNDATION</div>' : ''}
                    <h4 style="font-size: ${generation === 0 ? '14px' : '13px'}; font-weight: bold; color: #22d3ee; margin-bottom: 4px;">${genderIcon} ${dino.name}</h4>
                    <p style="font-size: ${generation === 0 ? '12px' : '11px'}; color: #cbd5e1; margin: 2px 0;">${dino.species}</p>
                    <p style="font-size: ${generation === 0 ? '12px' : '11px'}; color: #cbd5e1; margin: 2px 0;">Level ${finalLevel}</p>
                    <p style="font-size: 9px; color: #64748b; margin-top: 2px;">ID: ${dino.id}</p>
                    ${favoriteStats.length > 0 ? `<p style="color: #fbbf24; font-size: 10px; margin-top: 4px;">${favoriteStats.slice(0, 2).join(', ')}</p>` : ''}
                    ${parentInfo}
                    ${hasChildren ? '<p style="color: #22d3ee; font-size: 9px; margin-top: 2px;">Has Offspring ‚Üì</p>' : ''}
                </div>
            `;
        }

        function renderOrphanNode(dino) {
            const genderIcon = dino.gender === 'Male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
            const totalLevels = calculateTotalLevels(dino.stats);
            const finalLevel = dino.level + totalLevels;
            const genderClass = dino.gender === 'Male' ? 'male' : 'female';
            
            let favoriteStats = [];
            Object.entries(dino.stats).forEach(([stat, data]) => {
                if (data.favorite) {
                    favoriteStats.push(`${statConfig[stat].name}: ${formatStatValue(data.value, stat)}`);
                }
            });
            
            return `
                <div class="child-node lineage-node ${genderClass}" 
                     data-dino-id="${dino.id}"
                     data-dino-name="${dino.name}"
                     style="border-color: #fbbf24;">
                    <h4>${genderIcon} ${dino.name}</h4>
                    <p>${dino.species}</p>
                    <p>Level ${finalLevel}</p>
                    <p style="font-size: 9px; color: #64748b;">ID: ${dino.id}</p>
                    ${favoriteStats.length > 0 ? `<p style="color: #fbbf24; font-size: 9px; margin-top: 2px;">${favoriteStats[0]}</p>` : ''}
                    <p style="color: #f87171; font-size: 8px; margin-top: 2px;">Missing parent data</p>
                </div>
            `;
        }

        // ROBUST Lineage hover highlighting with clean ID system
        function highlightRelations(dinoId) {
            console.log(`=== HOVER DEBUG (Clean ID System) ===`);
            console.log(`Hovered dino ID: ${dinoId} (type: ${typeof dinoId})`);
            
            clearHighlights();
            
            const currentDino = findDinoById(dinoId);
            if (!currentDino) {
                console.log(`‚ùå ERROR: Dino with ID ${dinoId} not found`);
                return;
            }
            
            console.log(`Hovered dino: ${currentDino.name} (ID: ${currentDino.id})`);
            
            // Get parent and children IDs using ROBUST functions
            const parents = getParents(currentDino);
            const children = getChildren(currentDino.id);
            const parentIds = parents.map(p => p.id);
            const childrenIds = children.map(c => c.id);
            
            console.log(`Parents: [${parents.map(p => `${p.name} (${p.id})`).join(', ')}]`);
            console.log(`Children: [${children.map(c => `${c.name} (${c.id})`).join(', ')}]`);
            
            // Get all lineage nodes
            const allNodes = document.querySelectorAll('.lineage-dino-node');
            console.log(`Total lineage nodes found: ${allNodes.length}`);
            
            let currentCount = 0;
            let parentCount = 0;
            let childCount = 0;
            
            allNodes.forEach(node => {
                const nodeId = parseInt(node.dataset.dinoId);
                const nodeName = node.dataset.dinoName || 'Unknown';
                
                if (nodeId === dinoId) {
                    console.log(`‚úÖ WHITE (Current): ${nodeName} (${nodeId})`);
                    currentCount++;
                } else if (parentIds.includes(nodeId)) {
                    console.log(`üîµ CYAN (Parent): ${nodeName} (${nodeId})`);
                    node.classList.add('highlight-parent');
                    parentCount++;
                } else if (childrenIds.includes(nodeId)) {
                    console.log(`üü° GOLD (Child): ${nodeName} (${nodeId})`);
                    node.classList.add('highlight-child');
                    childCount++;
                } else {
                    node.classList.add('dim');
                }
            });
            
            console.log(`HIGHLIGHT SUMMARY - Current: ${currentCount}, Parents: ${parentCount}, Children: ${childCount}`);
        }
        
        function clearHighlights() {
            const allNodes = document.querySelectorAll('.lineage-dino-node');
            allNodes.forEach(node => {
                node.classList.remove('highlight-parent', 'highlight-child', 'dim');
            });
        }

        // Export data
        function exportData() {
            const exportData = {
                dinosaurs: dinosaurs,
                species: customSpeciesList,
                exportDate: new Date().toISOString(),
                version: '2.0' // Updated version for clean ID system
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ark-breeding-data-clean-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ROBUST Import data with clean ID migration
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.dinosaurs || !Array.isArray(importedData.dinosaurs)) {
                        throw new Error('Invalid file format');
                    }
                    
                    const importCount = importedData.dinosaurs.length;
                    const speciesCount = importedData.species ? importedData.species.length : 0;
                    
                    if (confirm(`Import ${importCount} dinosaurs and ${speciesCount} species? This will merge with your existing data and assign clean IDs.`)) {
                        // Merge species first
                        if (importedData.species) {
                            importedData.species.forEach(species => {
                                if (!customSpeciesList.includes(species)) {
                                    customSpeciesList.push(species);
                                }
                            });
                        }
                        
                        // Handle dinosaur conflicts
                        const conflicts = [];
                        importedData.dinosaurs.forEach(importDino => {
                            const existing = dinosaurs.find(d => d.name === importDino.name && d.species === importDino.species);
                            if (existing) {
                                conflicts.push(importDino.name);
                            }
                        });
                        
                        if (conflicts.length > 0 && !confirm(`${conflicts.length} dinosaurs have name conflicts: ${conflicts.slice(0, 3).join(', ')}${conflicts.length > 3 ? '...' : ''}. Continue import? (Conflicting names will get "(Imported)" suffix)`)) {
                            return;
                        }
                        
                        // Import dinosaurs with CLEAN IDs - no parent references yet
                        const idMapping = new Map();
                        importedData.dinosaurs.forEach(importDino => {
                            const existing = dinosaurs.find(d => d.name === importDino.name && d.species === importDino.species);
                            if (existing) {
                                importDino.name += ' (Imported)';
                            }
                            
                            // Store old ID for mapping
                            const oldId = importDino.id;
                            const newId = generateId();
                            idMapping.set(oldId, newId);
                            
                            // Assign clean ID and clear parent references temporarily
                            importDino.id = newId;
                            importDino.tempParent1Id = importDino.parent1Id;
                            importDino.tempParent2Id = importDino.parent2Id;
                            importDino.parent1Id = null;
                            importDino.parent2Id = null;
                            
                            dinosaurs.push(importDino);
                        });
                        
                        // Now fix parent references using the mapping
                        dinosaurs.forEach(dino => {
                            if (dino.tempParent1Id) {
                                const newParent1Id = idMapping.get(dino.tempParent1Id);
                                if (newParent1Id) {
                                    dino.parent1Id = newParent1Id;
                                }
                                delete dino.tempParent1Id;
                            }
                            
                            if (dino.tempParent2Id) {
                                const newParent2Id = idMapping.get(dino.tempParent2Id);
                                if (newParent2Id) {
                                    dino.parent2Id = newParent2Id;
                                }
                                delete dino.tempParent2Id;
                            }
                        });
                        
                        updateNextId();
                        saveData();
                        populateSpeciesDropdown();
                        populateMainSpeciesFilter();
                        renderDinosaurs();
                        updateParentSelects();
                        updateModalParentSelects();
                        populateSpeciesFilter();
                        updateBreedingPreview();
                        
                        alert(`Successfully imported ${importCount} dinosaurs with clean IDs!`);
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // Handle Enter key for adding species  
        document.addEventListener('DOMContentLoaded', function() {
            const newSpeciesInput = document.getElementById('newSpecies');
            if (newSpeciesInput) {
                newSpeciesInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addSpecies();
                    }
                });
            }
        });

        // Update level calculation when level changes
        document.addEventListener('DOMContentLoaded', function() {
            const dinoLevelInput = document.getElementById('dinoLevel');
            if (dinoLevelInput) {
                dinoLevelInput.addEventListener('input', updateLevelCalculation);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>